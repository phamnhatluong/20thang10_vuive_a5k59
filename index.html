<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Galaxy Upload - Cloudinary + Firebase</title>
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/addons/controls/OrbitControls.js": "https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js"
      }
    }
  </script>
</head>

<body>
  <div id="container">
    <div id="image-input-container">
      <label><b>Chá»n áº£nh Ä‘á»ƒ táº£i lÃªn (cÃ³ thá»ƒ chá»n nhiá»u):</b></label><br />
      <input type="file" id="image-upload" accept="image/*" multiple /><br /><br />

      <textarea id="image-links" rows="4" cols="40" readonly placeholder="Link chia sáº» sáº½ hiá»‡n á»Ÿ Ä‘Ã¢y..."></textarea><br />
      <button id="generate-link">ğŸ“‹ Copy link chia sáº»</button>
    </div>
  </div>

  <!-- Script upload Cloudinary + Firebase -->
  <script type="module">
    // ==== 1ï¸âƒ£ Import Firebase SDK ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ==== 2ï¸âƒ£ Firebase Config ====
    const firebaseConfig = {
      apiKey: "AIzaSyCnWKoYXwf4zz_3cndM9TXI7pJJmSALMa4",
      authDomain: "pnl-53051.firebaseapp.com",
      projectId: "pnl-53051",
      storageBucket: "pnl-53051.firebasestorage.app",
      messagingSenderId: "441869406071",
      appId: "1:441869406071:web:9daf7906bd8b9f47279b72",
      measurementId: "G-7NERQH0HLZ"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    // ==== 3ï¸âƒ£ Cloudinary Config ====
    const CLOUD_NAME = "dpihfxijg";       // âœ… Cloudinary cá»§a báº¡n
    const UPLOAD_PRESET = "20-10-pnl";    // âœ… Preset unsigned

    // ==== 4ï¸âƒ£ Upload áº£nh ====
    const uploadInput = document.getElementById("image-upload");
    const imageLinksTextarea = document.getElementById("image-links");
    const copyBtn = document.getElementById("generate-link");

    uploadInput.addEventListener("change", async (event) => {
      const files = event.target.files;
      if (!files.length) return alert("Báº¡n chÆ°a chá»n áº£nh!");

      // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i
      imageLinksTextarea.value = "â³ Äang táº£i áº£nh lÃªn Cloudinary...";
      copyBtn.disabled = true;

      try {
        // Upload táº¥t cáº£ áº£nh song song (nhanh hÆ¡n)
        const uploads = [...files].map(async (file) => {
          const formData = new FormData();
          formData.append("file", file);
          formData.append("upload_preset", UPLOAD_PRESET);

          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: "POST",
            body: formData
          });

          const data = await res.json();
          if (!data.secure_url) throw new Error(data.error?.message || "Upload tháº¥t báº¡i Cloudinary");
          return data.secure_url;
        });

        const cloudinaryURLs = await Promise.all(uploads);
        console.log("âœ… áº¢nh Cloudinary:", cloudinaryURLs);

        // ==== 5ï¸âƒ£ LÆ°u danh sÃ¡ch link vÃ o Firebase ====
        const jsonBlob = new Blob([JSON.stringify(cloudinaryURLs, null, 2)], { type: "application/json" });
        const fileRef = ref(storage, `urls/${Date.now()}.json`);
        await uploadBytes(fileRef, jsonBlob);
        const jsonURL = await getDownloadURL(fileRef);

        // ==== 6ï¸âƒ£ Táº¡o link chia sáº» ====
        const redirectURL = `${window.location.origin}/?images=${encodeURIComponent(jsonURL)}`;
        imageLinksTextarea.value = redirectURL;

        // Copy link
        await navigator.clipboard.writeText(redirectURL);
        alert("âœ… Táº£i áº£nh thÃ nh cÃ´ng! Link chia sáº» Ä‘Ã£ Ä‘Æ°á»£c sao chÃ©p:\n" + redirectURL);
      } catch (err) {
        console.error("âŒ Lá»—i upload:", err);
        alert("ÄÃ£ xáº£y ra lá»—i khi táº£i áº£nh. Vui lÃ²ng thá»­ láº¡i!");
        imageLinksTextarea.value = "";
      } finally {
        copyBtn.disabled = false;
      }
    });

    // ==== 7ï¸âƒ£ Copy link thá»§ cÃ´ng ====
    copyBtn.addEventListener("click", () => {
      const text = imageLinksTextarea.value.trim();
      if (!text || text.startsWith("â³")) {
        alert("ChÆ°a cÃ³ link Ä‘á»ƒ copy!");
        return;
      }
      navigator.clipboard.writeText(text);
      alert("âœ… Link chia sáº» Ä‘Ã£ Ä‘Æ°á»£c copy!");
    });
  </script>

  <!-- Script galaxy hiá»ƒn thá»‹ áº£nh -->
  <script type="module" src="./galaxy.js"></script>
</body>
</html>
